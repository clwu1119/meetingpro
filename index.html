<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive 相簿</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; padding: 20px; text-align: center; background: #f0f2f5; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin: 10px; }
        .btn-auth { background: #4285f4; color: white; }
        .btn-upload { background: #34a853; color: white; display: none; }
        #fileList { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; margin-top: 20px; }
        .img-card { background: white; padding: 5px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .img-card img { width: 100%; border-radius: 5px; height: 120px; object-fit: cover; }
    </style>
</head>
<body>

    <h2>我的雲端相簿</h2>
    
    <button id="auth_btn" class="btn btn-auth" onclick="handleAuthClick()">登入 Google 帳號</button>
    <button id="signout_btn" class="btn" style="display:none;" onclick="handleSignoutClick()">登出</button>

    <hr>

    <div id="upload_section" style="display:none;">
        <input type="file" id="fileInput" accept="image/*">
        <button class="btn btn-upload" id="upload_btn" onclick="uploadFile()">開始上傳</button>
    </div>

    <div id="fileList"></div>

    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <script>
        /* --- 設定區 --- */
        const CLIENT_ID = '你的CLIENT_ID.apps.googleusercontent.com'; // 填入你的 Client ID
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        let tokenClient;
        let accessToken = null;

        // 1. 初始化 API
        function gapiLoaded() { gapi.load('client', () => gapi.client.init({})); }
        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    accessToken = tokenResponse.access_token;
                    document.getElementById('auth_btn').innerText = '已授權';
                    document.getElementById('upload_section').style.display = 'block';
                    document.getElementById('signout_btn').style.display = 'inline-block';
                    listImages(); // 登入後抓取圖片
                },
            });
        }

        function handleAuthClick() { tokenClient.requestAccessToken(); }
        function handleSignoutClick() {
            google.accounts.oauth2.revokeToken(accessToken);
            location.reload();
        }

        // 2. 上傳檔案邏輯
        async function uploadFile() {
            const file = document.getElementById('fileInput').files[0];
            if (!file) return alert('請先選擇檔案');

            const metadata = { 'name': file.name, 'mimeType': file.type };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
                method: 'POST',
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                body: form
            }).then(response => {
                alert('上傳成功！');
                listImages(); // 刷新清單
            });
        }

        // 3. 列出雲端硬碟中的圖片 (僅限此 App 上傳的)
        async function listImages() {
            const response = await fetch('https://www.googleapis.com/drive/v3/files?q=mimeType contains "image/"&fields=files(id, name, thumbnailLink)', {
                headers: new Headers({ 'Authorization': 'Bearer ' + accessToken })
            });
            const data = await response.json();
            const container = document.getElementById('fileList');
            container.innerHTML = '';
            
            data.files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'img-card';
                div.innerHTML = `<img src="${file.thumbnailLink.replace('=s220', '=s500')}" alt="${file.name}"><p>${file.name}</p>`;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
